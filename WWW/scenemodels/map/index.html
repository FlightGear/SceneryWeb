<!DOCTYPE html>
<html>
<head>
    <title>FlightGear Scenemodels Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" href="http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.css" />
    <style>
html, body, #map {
  width: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
}
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script src="http://matchingnotes.com/javascripts/leaflet-google.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.min.js"></script>

    <script>

        function getRequestParameter(name) {
           if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
              return decodeURIComponent(name[1]);
        }

        var lat = getRequestParameter('lat') || 0;
        var lon = getRequestParameter('lon') || 0;
        var zoom = getRequestParameter('z') || 3;

        var map = L.map('map').setView([lat, lon], zoom);

        var osm_layer = L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {
                maxZoom : 18,
                attribution : 'Map data &copy; <a target="_blank" href="http://openstreetmap.org">OpenStreetMap</a> contributors'
            }).addTo(map);

        var ggle_road_layer = new L.Google('ROADMAP');
        var ggle_sat_layer = new L.Google('SATELLITE');

        L.ScenemodelsLayer = L.GeoJSON.extend({
          options : {
//            pointToLayer : function(feature, latlng) {
//                return L.marker(latlng, options);
//            },

            onEachFeature : function(feature, layer) {
                var popupContent = "<p><a href='/app.php?c=Objects&a=view&id=" + feature.id + "' target='_blank'>Model #" + feature.id + "</a></p>";
                if (feature.properties) {
                    function makePopupContentPropertyEntry(title,props,key) {
                      if(key in props)  return '<li>' + title + ':' + props[key] + '</li>';
                      return '';
                    }
                    if( feature.properties.model_id )
                      popupContent += '<div><img alt="Model Thumbnail" src="/app.php?c=Models&a=thumbnail&id=' + feature.properties.model_id + '"></img>'
                    popupContent += '</div>';
                    popupContent += '<ul>';
                    popupContent += makePopupContentPropertyEntry('Title', feature.properties, 'title' );
                    popupContent += makePopupContentPropertyEntry('Heading', feature.properties, 'heading' );
                    popupContent += makePopupContentPropertyEntry('Ground Elevation', feature.properties, 'gndelev' );
                    popupContent += makePopupContentPropertyEntry('Elevation Offset', feature.properties, 'elevoffset' );
                    popupContent += '</ul>';
                }

                layer.bindPopup(popupContent);
            },
          },

          onAdd : function(map) {
            L.GeoJSON.prototype.onAdd.call(this, map);
            this.refresh(map);
          },

          refresh: function(map) {
            var self = this;
            var bounds = map.getBounds();
            var url = "/svc/getobjects?w=" + bounds.getWest() 
                                       + "&e=" + bounds.getEast() 
                                       + "&n=" + bounds.getNorth() 
                                       + "&s=" + bounds.getSouth(); 

            if( map.getZoom() > 10 ) {
                var jqxhr = $.get(url).done(function(data) {
                    self.clearLayers();
                    self.addData.call(self, data);
                }).fail(function() {
                    console.log('failed to load scenemodels data');
                }).always(function() {
                });
              }
          },

        });

        L.scenemodelsLayer = function(options) {
          return new L.ScenemodelsLayer(null, options);
        }

        var scenemodelsLayer = L.scenemodelsLayer({
        }).addTo(map);

        var baseLayers = {
            "Openstreetmap": osm_layer,
            "Google Road": ggle_road_layer,
            "Google Satelite": ggle_sat_layer,
        }

        var overlays = {
            "Scenemodels": scenemodelsLayer,
        }

        L.control.layers(baseLayers, overlays).addTo(map);

        L.control.coordinates({
            position:"bottomleft",
            decimals:6,
            decimalSeperator:",",
            labelTemplateLat:"Lat: {y}",
            labelTemplateLng:"Lng: {x}"
        }).addTo(map);
        L.control.coordinates({
            position:"bottomleft",
            useDMS:true,
            labelTemplateLat:"N {y}",
            labelTemplateLng:"E {x}",
            useLatLngOrder:true
        }).addTo(map);


        map.on( "moveend", function(e) {
          scenemodelsLayer.refresh( map );
        });

    </script>
</body>
</html>

