<!DOCTYPE html>
<html>
<head>
    <title>FlightGear Scenemodels Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" href="http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.css" />
    <link rel="stylesheet" href="http://aratcliffe.github.io/Leaflet.contextmenu/dist/leaflet.contextmenu.css" />
    <style>
html, body, #map {
  width: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
}

.leaflet-container {
  cursor: crosshair !important;
}

.leaflet-grid-label .lng {
	margin-left: 8px;
	-webkit-transform: rotate(90deg);
	transform: rotate(90deg);
}

.leaflet-grid-label .lat, 
.leaflet-grid-label .lng {
	text-shadow: -2px 0 #FFFFFF, 0 2px #FFFFFF, 2px 0 #FFFFFF, 0 -2px #FFFFFF;
}
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.min.js"></script>
    <script src="http://aratcliffe.github.io/Leaflet.contextmenu/dist/leaflet.contextmenu.js"></script>
    <script src="tilegrid.js"></script>

    <script>

        function getRequestParameter(name) {
           if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
              return decodeURIComponent(name[1]);
        }

        var lat = getRequestParameter('lat') || 0;
        var lon = getRequestParameter('lon') || 0;
        var zoom = getRequestParameter('z') || 3;
        var icao = getRequestParameter('icao');

        var map = L.map('map', {
            contextmenu: true,
            contextmenuItems: [{
		      text: 'Get coordinates',
		      callback: function(e) { 
                          window.prompt('Copy to clipboard: Ctrl+C, Enter', e.latlng.lng.toFixed(6) + ' ' + e.latlng.lat.toFixed(6) ); 
                      },
	      }, {
		      text: 'Center map here',
		      callback: function(e) { map.panTo(e.latlng); },
	      }, 
	      ]
        }).setView([lat, lon], zoom);

        var osm_layer = L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {
                minZoom : 3,
                maxZoom : 18,
                attribution : 'Map data &copy; <a target="_blank" href="http://openstreetmap.org">OpenStreetMap</a> contributors'
            }).addTo(map);

        var esriLayer = L.tileLayer( 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="http://www.esri.com/">Esri</a>, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
        maxZoom: 18,
        });

        L.ScenemodelsLayer = L.GeoJSON.extend({
          options : {
            pointToLayer : function(feature, latlng) {
                var color = feature.properties.shared > 0 ? '#ff1010' : '#1010ff';
                var marker = L.circleMarker(latlng, {
                    radius: 4,
                    fillColor: color,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8,
                });
                return marker;
            },

            onEachFeature : function(feature, layer) {
                var popupContent = "<div><a href='/app.php?c=Objects&a=view&id=" + feature.id + "' target='_blank'>Object #" + feature.id + "</a></div>";
                popupContent += "<a href='http://scenery.flightgear.org/map/?lat=" + feature.geometry.coordinates[1] +
                                                                            "&lon=" + feature.geometry.coordinates[0] +
                                                                            "&z=13&obj=" + feature.properties.model_id + "'>permalink</a>";
                if (feature.properties) {
                    function makePopupContentPropertyEntry(title,props,key) {
                      if(key in props)  return '<li>' + title + ':' + props[key] + '</li>';
                      return '';
                    }
                    if( feature.properties.model_id )
                      popupContent += '<div><img width="160" height="120" alt="Model Thumbnail" src="/app.php?c=Models&a=thumbnail&id=' + feature.properties.model_id + '"></img></div>'
                    popupContent += '<ul>';
                    popupContent += makePopupContentPropertyEntry('Title', feature.properties, 'title' );
                    popupContent += makePopupContentPropertyEntry('Heading', feature.properties, 'heading' );
                    popupContent += makePopupContentPropertyEntry('Ground Elevation', feature.properties, 'gndelev' );
                    popupContent += makePopupContentPropertyEntry('Elevation Offset', feature.properties, 'elevoffset' );
                    popupContent += makePopupContentPropertyEntry('Shared', feature.properties, 'shared' );
                    popupContent += makePopupContentPropertyEntry('STG', feature.properties, 'stg' );
                    popupContent += '</ul>';
                }

                layer.bindPopup(popupContent, {
                    autoPan: false
                });
            },
          },

          onAdd : function(map) {
            L.GeoJSON.prototype.onAdd.call(this, map);
            this.refresh(map);
          },

          refresh: function(map) {
            var self = this;
            self.clearLayers();
            var bounds = map.getBounds();
            var url = "/svc/getobjects?w=" + bounds.getWest() 
                                       + "&e=" + bounds.getEast() 
                                       + "&n=" + bounds.getNorth() 
                                       + "&s=" + bounds.getSouth(); 

            if( map.getZoom() > 12 ) {
                var jqxhr = $.get(url).done(function(data) {
                    self.addData.call(self, data);
                }).fail(function() {
                    console.log('failed to load scenemodels data');
                }).always(function() {
                });
              } else {
                // make a grid of 200x200px for the map and display number
                // of objects instead of individual objects per grid
                var bounds = map.getBounds();
                var mapWidth = $('#map').width();
                var mapHeight = $('#map').height();
                var gridSizeX = Math.floor(mapWidth/200);
                var gridSizeY = Math.floor(mapHeight/200);
                var degPerPixelX = (bounds.getEast()-bounds.getWest())/mapWidth;
                var degPerPixelY = (bounds.getNorth()-bounds.getSouth())/mapWidth;
              }
          },

        });

        L.scenemodelsLayer = function(options) {
          return new L.ScenemodelsLayer(null, options);
        }

        var scenemodelsLayer = L.scenemodelsLayer({
        }).addTo(map);

        L.SignsLayer = L.GeoJSON.extend({
          options : {
            pointToLayer : function(feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 3,
                    fillColor: 'yellow',
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8,
                });
            },

            onEachFeature : function(feature, layer) {
                var popupContent = "";
                popupContent += "<a href='http://scenery.flightgear.org/map/?lat=" + feature.geometry.coordinates[1] +
                                                                            "&lon=" + feature.geometry.coordinates[0] +
                                                                            "&z=13&obj=" + feature.properties.model_id + "'>permalink</a>";
                if (feature.properties) {
                    popupContent += '<div><span>Sign: </span><span>' + feature.properties.definition;
                    popupContent += '<div><span>Heading: </span><span>' + feature.properties.heading;
                    popupContent += '<div><span>Elevation: </span><span>' + feature.properties.gndelev;
                }

                layer.bindPopup(popupContent);
            },
          },

          onAdd : function(map) {
            L.GeoJSON.prototype.onAdd.call(this, map);
            this.refresh(map);
          },

          refresh: function(map) {
            var self = this;
            var bounds = map.getBounds();
            self.clearLayers();
            var url = "/svc/getsigns?w=" + bounds.getWest() 
                                       + "&e=" + bounds.getEast() 
                                       + "&n=" + bounds.getNorth() 
                                       + "&s=" + bounds.getSouth(); 

            if( map.getZoom() > 13 ) {
                var jqxhr = $.get(url).done(function(data) {
                    self.addData.call(self, data);
                }).fail(function() {
                    console.log('failed to load scenemodels data');
                }).always(function() {
                });
              }
          },

        });

        L.signsLayer = function(options) {
          return new L.SignsLayer(null, options);
        }

        var signsLayer = L.signsLayer({
        }).addTo(map);

    
        var grid = L.tileGrid().addTo(map);

        var baseLayers = {
            "Openstreetmap": osm_layer,
            "Esri World Imagery" : esriLayer,
        }

        var overlays = {
            "Scenemodels": scenemodelsLayer,
            "Signs": signsLayer,
            "Grid":  grid,
        }

        L.control.layers(baseLayers, overlays).addTo(map);

        L.control.coordinates({
            position:"bottomleft",
            decimals:6,
            decimalSeperator:",",
            labelTemplateLat:"Lat: {y}",
            labelTemplateLng:"Lng: {x}"
        }).addTo(map);
        L.control.coordinates({
            position:"bottomleft",
            useDMS:true,
            labelTemplateLat:"N {y}",
            labelTemplateLng:"E {x}",
            useLatLngOrder:true
        }).addTo(map);

        map.on( "moveend", function(e) {
          scenemodelsLayer.refresh( map );
          signsLayer.refresh( map );
        });

        if( icao ) {
            var url = "/svc/getapt?icao=" + icao;
            var jqxhr = $.get(url).done(function(data) {
              var geoJson = L.geoJson( data, {
                style: {
                  'color': '#404040',
                  'weight': 2,
                  'opacity': 0.5,
                  'fill': true,
                  'fillColor': '#c0c0c0',
                  'fillOpacity': 0.5,
                },
              }).addTo(map);
              map.fitBounds(geoJson.getBounds());
            }).fail(function() {
              console.log('failed to load airport layout');
            }).always(function() {
            });
        }

    </script>
</body>
</html>

